<!DOCTYPE html>
<html>
<head>
    <title>Transmissor de Áudio</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="/socket.io/socket.io.js"></script>
</head>
<body>
    <div style="text-align: center; padding: 20px;">
        <h2>Transmissor 1</h2>
        <button id="startButton">Iniciar Transmissão</button>
        <button id="stopButton" disabled>Parar Transmissão</button>
        <div id="status" style="margin-top: 20px;">Desconectado</div>
        <div id="volumeMeter" style="margin-top: 10px; height: 20px; background: #eee;">
            <div id="volumeBar" style="height: 100%; width: 0%; background: #4CAF50;"></div>
        </div>
    </div>

    <script>
        // Conecta ao servidor - substitua com seu URL do Render
        const socket = io();
        let mediaRecorder;
        let audioContext;
        let analyser;
        let dataArray;
        let isTransmitting = false;

        const startButton = document.getElementById('startButton');
        const stopButton = document.getElementById('stopButton');
        const status = document.getElementById('status');
        const volumeBar = document.getElementById('volumeBar');

        socket.on('connect', () => {
            status.textContent = 'Conectado';
            startButton.disabled = false;
        });

        socket.on('disconnect', () => {
            status.textContent = 'Desconectado';
            stopTransmission();
        });

        startButton.onclick = async () => {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                
                // Configurar análise de áudio
                audioContext = new AudioContext();
                const source = audioContext.createMediaStreamSource(stream);
                analyser = audioContext.createAnalyser();
                source.connect(analyser);
                
                analyser.fftSize = 256;
                dataArray = new Uint8Array(analyser.frequencyBinCount);
                
                mediaRecorder = new MediaRecorder(stream);
                
                mediaRecorder.ondataavailable = (event) => {
                    if (event.data.size > 0 && isTransmitting) {
                        socket.emit('audio-stream', event.data);
                    }
                };

                mediaRecorder.start(100);
                isTransmitting = true;
                
                startButton.disabled = true;
                stopButton.disabled = false;
                status.textContent = 'Transmitindo';
                
                // Atualizar medidor de volume
                updateVolumeMeter();
                
            } catch (error) {
                console.error('Erro:', error);
                status.textContent = 'Erro ao acessar microfone';
            }
        };

        function updateVolumeMeter() {
            if (!isTransmitting) return;
            
            analyser.getByteFrequencyData(dataArray);
            let volume = dataArray.reduce((a, b) => a + b) / dataArray.length;
            volumeBar.style.width = (volume * 100 / 256) + '%';
            
            requestAnimationFrame(updateVolumeMeter);
        }

        stopButton.onclick = stopTransmission;

        function stopTransmission() {
            if (mediaRecorder && mediaRecorder.state !== 'inactive') {
                mediaRecorder.stop();
            }
            isTransmitting = false;
            startButton.disabled = false;
            stopButton.disabled = true;
            status.textContent = 'Conectado';
            volumeBar.style.width = '0%';
        }
    </script>
</body>
</html>